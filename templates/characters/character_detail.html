{% extends 'base.html' %}



{% block content %}

<div style="display:none;">
  {% csrf_token %}
</div>

<div class="page-container">

    <div class="Hero-Section">
        <h1>{{character.name}}</h1>
        <br>
        <h3>{{character.character_class}}</h3>
        <p>XP: {{character.xp}}</p>
    </div>

    <div class="two-column-section">

    <div class="left-column">

        <div class="banner">
            <h1>üìã Attributes</h1>
        </div>

        <!-- this container holds primary attributes such as agility, cunning etc -->
        <div class="attribute-container">
             <div class="attribute-card">
                <h1>‚ö°Ô∏è</h1>
                <p>agility</p>
                <h1>{{character.agility}}</h1>
             </div>
        
             <div class="attribute-card">
                <h1>üß†</h1>
                <p>Cunning</p>
                <h1>{{character.cunning}}</h1>
             </div>
    
             <div class="attribute-card">
                <h1>üëª</h1>
                <p>spirit</p>
                <h1>{{character.spirit}}</h1>
             </div>

             <div class="attribute-card">
                <h1>üí™</h1>
                <p>strength</p>
                <h1>{{character.strength}}</h1>
             </div>

             <div class="attribute-card">
                <h1>üìñ</h1>
                <p>lore</p>
                <h1>{{character.lore}}</h1>
             </div>

             <div class="attribute-card">
                <h1>üé≤</h1>
                <p>luck</p>
                <h1>{{character.luck}}</h1>
             </div>
        </div> <!-- attribute container-->



        <div class="banner">
            <h1>‚öîÔ∏è Combat</h1>
        </div>

        <!-- this container holds combat information -->
        <div class="attribute-container">
             <div class="attribute-card">
                <h1>üèÉ</h1>
                <p>Initiative</p>
                <h1>{{character.initiative}}</h1>
             </div>
        
             <div class="attribute-card">
                <h1>üèπ</h1>
                <p>Range</p>
                <h1>{{character.range}}+</h1>
             </div>
    
             <div class="attribute-card">
                <h1>üó°Ô∏è</h1>
                <p>Melee | combat:  <span style="font-size: 1.5em; font-weight: bold;">{{character.combat}}</span> </p>
                <h1>{{character.melee}}+</h1>
             </div>
        </div> <!-- attribute container-->


        <div class="banner">
            <h1>ü´Ä Vitality</h1>
        </div>

        <div class="vitality-container">  

            <div class="vital-card" id="health-card" style="position: relative;">
                <div class="vital-label" id="health_emoji">
                    {% if character.calculated_health == 0 %}
                        üòµ
                    {% elif character.calculated_health <= 30 %}
                        ü§ï
                    {% elif character.calculated_health <= 60 %}
                        ü´§
                    {% elif character.calculated_health <= 90 %}
                        üôÇ
                    {% else %}
                        üòÉ
                    {% endif %}
                    Health
                </div>

                <div class="vital-label">üõ°Ô∏è Armor: <span style="font-size: 1.2em;">{{character.armor}}</span></div>
                
                <div class="vital-bar">
                    <div class="vital-fill" id = "health_bar" style="width:{{character.calculated_health}}%"></div>
                    <div class="vital-text" id="health_stat">{{character.health}} / {{character.max_health}}</div>
                </div>

                <!-- Left button (decrease health) -->
                <button class="health-btn health-btn-left" onclick="update_health(-1)">‚àí</button>
                <!-- Right button (increase health) -->
                <button class="health-btn health-btn-right" onclick="update_health(1)">+</button>
            </div> <!-- vitality card-->


            <div class="vital-card sanity">
                <div class="vital-label" id="sanity_emoji">{% if character.calculated_sanity == 0 %}
                        üò±
                    {% elif character.calculated_sanity <= 30 %}
                        üò®
                    {% elif character.calculated_sanity <= 60 %}
                        üòß
                    {% elif character.calculated_sanity <= 90 %}
                        üòêÔ∏è
                    {% else %}
                        üòÉ
                    {% endif %} Sanity
                </div>

                <div class="vital-bar">
                    <div class="vital-fill" id="sanity_bar" style="width:{{character.calculated_sanity}}%"></div>
                    <div class="vital-text" id="sanity_stats">{{character.sanity}} / {{character.max_sanity}}</div> 
                </div>
                
                <!-- Left button (decrease sanity) -->
                <button class="health-btn health-btn-left" onclick="update_sanity(-1)">‚àí</button>
                
                <!-- Right button (increase sanity) -->
                <button class="health-btn health-btn-right" onclick="update_sanity(1)">+</button>
            </div> <!-- sanity card-->

        
        
        
        </div> <!-- vitality continer-->


    </div> <!-- Left conainter-->
    
    <div class="right-column">
        <!-- Your right side content here -->
    </div>
</div>


        

    




</div>

<script>
// Get CSRF token from the hidden div
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Get the current URL (character detail page URL)
const currentURL = "{% url 'character_detail' character.pk %}";

// DOM elements
const cycleBtn = document.getElementById('CycleAbilityBtn');

// Utility function to send and receive data from backend
async function fetchData(url, dataDict) {
    try {
        // convert the dataDict into something the 
        const formBody = new URLSearchParams(dataDict).toString();

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formBody
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Something went wrong');
        }

        return data; // returns the backend's response as a dictionary
    } catch (error) {
        console.error('Error in fetchData:', error);
        throw error; // propagate error to caller
    }
}


cycleBtn.addEventListener('click', async function() {
    // elements that will be updated
    const abilityNameEl = document.getElementById('CurrentAbilityName');
    const abilityDescEl = document.getElementById('CurrentAbilityDescription');

    try {
        // send data into the back end and get the response
        const data = await fetchData(currentURL, { action: 'cycle_ability' });

        // if there is a valid response
        if (data.new_ability_name) {
            abilityNameEl.textContent = data.new_ability_name;
            abilityDescEl.textContent = data.new_ability_description;
        } else {
            abilityNameEl.textContent = 'No Abilities';
            abilityDescEl.textContent = 'No abilities available';
        }

    } catch (error) {
        alert('Failed to cycle ability: ' + error.message);
    }
});


async function update_horror(num){
    horror_label = document.getElementById('horror_stat')
    try {
        // send data into the back end and get the response
        const data = await fetchData(currentURL, { action: 'horror', amount: num });

        // if there is a valid response
        if (data.horror !== undefined) {
            horror_label.textContent = `${data.horror} / ${data.max_horror}`
        } 
    } catch (error) {
        alert('Failed to cycle ability: ' + error.message);
    }
}

async function update_grit(num){
    grit_label = document.getElementById('grit_stat')
    try {
        // send data into the back end and get the response
        const data = await fetchData(currentURL, { action: 'grit', amount: num });

        // if there is a valid response
        if (data.grit !== undefined) {
            grit_label.textContent = `${data.grit} / ${data.max_grit}`
        } 
    } catch (error) {
        alert('Failed to cycle ability: ' + error.message);
    }
}


async function update_health(num){
    const health_label = document.getElementById('health_stat');
    const vital_fill = document.getElementById('health_bar');
    const health_emoji = document.getElementById('health_emoji');
    
    try {
        const data = await fetchData(currentURL, { action: 'health', amount: num});

        if (data.success) {
            // Update health text
            if (data.health !== undefined) {
                health_label.textContent = `${data.health} / ${data.max_health}`;
            }
            
            // Update health bar width with smooth transition
            if (data.calculated_health !== undefined) {
                vital_fill.style.width = `${data.calculated_health}%`;
                
                // Update emoji based on health percentage
                let emoji = 'üòÉ';
                if (data.calculated_health == 0) {
                    emoji = 'üòµ';
                } else if (data.calculated_health <= 30) {
                    emoji = 'ü§ï';
                } else if (data.calculated_health <= 60) {
                    emoji = 'ü´§';
                } else if (data.calculated_health <= 90) {
                    emoji = 'üôÇ';
                }
                
                health_emoji.innerHTML = `${emoji} Health`;
            }
        } 
    } catch (error) {
        alert('Failed to update health: ' + error.message);
    }
}


async function update_sanity(num) {
    const sanity_stats = document.getElementById('sanity_stats')
    const satiny_bar = document.getElementById('sanity_bar')
    const sanity_emoji = document.getElementById('sanity_emoji')

    try {
        const data = await fetchData(currentURL, { action: 'sanity', amount: num});

        if (data.success) {
            // Update sanity text
            if (data.sanity !== undefined) {
                sanity_stats.textContent = `${data.sanity} / ${data.max_sanity}`;
            }
            
            // Update health bar width with smooth transition
            if (data.calculated_sanity !== undefined) {
                sanity_bar.style.width = `${data.calculated_sanity}%`;


                // Update emoji based on sanity percentage
                let emoji = 'üòÉ';
                if (data.calculated_sanity == 0) {
                    emoji = 'üò±';
                } else if (data.calculated_sanity <= 30) {
                    emoji = 'üò®';
                } else if (data.calculated_sanity <= 60) {
                    emoji = 'üòß';
                } else if (data.calculated_sanity <= 90) {
                    emoji = 'üòêÔ∏è';
                }
                sanity_emoji.innerHTML = `${emoji} Sanity`;
            }
        } 
    } catch (error) {
        alert('Failed to update Sanity: ' + error.message);
    }
}

</script>
{% endblock content %}



